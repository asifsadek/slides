<!DOCTYPE html>
<html>
  <head>
    <title>OpenCL Advanced</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif);
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Serif', 'Microsoft JhengHei';
      }
      h1, h2, h3 {
        font-family: 'Droid Serif', Helvetica, 'Yanone Kaffeesatz', 'Microsoft JhengHei';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content {background: #272822; color: white; }
      .remark-slide-content h1 { font-size: 3.5em; }
      .remark-slide-content h2 { font-size: 2.5em; }
      .remark-slide-content h3 { font-size: 2em; }
      .remark-slide-content p { font-size: 1.3em; }
      .remark-slide-content blockquote { border-left: 5px solid rgba(152,232,99,0.8); margin: 0.65em 0 0.65em 4%; padding-left: 1%; padding-right: 1%; }
      .remark-slide-content img { max-width: 90%; max-height: 400px; }
      .remark-slide-content table { border: 1px solid #696969; width: 100%; margin: 1px;}
      .remark-slide-content table thead { font-family: "Times New Roman"; }
      .remark-slide-content table th, .remark-slide-content table td, .remark-slide-content table tr  { padding: 1px 2px; border: 1px solid #696969; }
      .remark-slide-content table tbody { font-family: "Ubuntu Mono"; }
      .remark-slide-content .big { font-size: 2em; }
      .remark-slide-content .small-image { max-width: 50%; }
      .remark-slide-content strong {color: red;}
      .white-background {background: white;}
      .white-background {color: black;}
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      li p { line-height: 1.5em; }
      .red { color: #fa0000; }
      .large { font-size: 2em; }
      a, a > code {
        color: rgb(249, 38, 114);
        text-decoration: none;
      }
      code {
/*        background: #e7e8e2;*/
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      .pull-left {
        float: left;
        width: 47%;
      }
      .pull-right {
        float: right;
        width: 47%;
      }
      .pull-right ~ p {
        clear: both;
      }
      #slideshow .slide .content code {
        font-size: 0.8em;
      }
      #slideshow .slide .content pre code {
        font-size: 0.9em;
        padding: 15px;
      }
      .inverse {
        background: #272822;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
		font-size: 2em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 2em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }

      /* Two-column layout */
      .left-column {
        width: 48%;
        height: 92%;
		float: left;
      }
        .left-column h2:last-of-type, .left-column h3:last-child {
          color: #000;
        }
      .right-column {
        width: 48%;
		float: right;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

title: Multiple Devices
class: center, middle

## OpenCL Advanced ##

## Multiple Devices ##

### 注意事項 ###

R04922067 楊翔雲, Morris

NTU CSIE

---

class: center, middle

## NVIDIA GPU ##

---

## 那麼一點特別 ##

* `clEnqueue{Read|Write}*`
  * 官方有提供 blocking / non-blocking 控制參數

  * 沒意外地，AMD/Intel 按照規格完成

  * 在 NVIDIA 上，**大部分** 屬於 blocking 操作

紅字部分在未來也許會更動

---

## 那麼一點特別 ##

* `clEnqueueNDRangeKernel` 
  * 沒有明確規範 blocking / non-blocking

  * 在 AMD/Intel 上，大部分屬於 non-blocking 操作

  * 在 NVIDIA 上，**大部分** 屬於 blocking 操作

紅字部分在未來也許會更動

---

class: center, middle

## 多少有點疑惑 ##

### 你們在實作同一個 OpenCL？ ###

### ？？ ###

---

## OpenCL Execution Model ##

### 尋找遺失的實作細節 ###

* 它是我們這堂課可能還未理解的部分

* 在不同廠牌上的實作撲朔迷離

* 如果你還沒看過 [Advanced OpenCL Event Model Usage](http://sa09.idav.ucdavis.edu/docs/SA09-opencl-dg-events-stream.pdf)

* 現在讓你看看

---

## 讀後感 ##

* 便利性相當強大

* Separate/Cooperative Multi-Device Usage Model  
似乎就是我們所要需要的部分

* Combined Memory Pool  
在 Cooperative 部分有一個定義不明確的部分，請**小心**服用

---

class: center, middle

## 除錯 Debug ##

---

## 錯誤案例 Race Condition ##

當使用多個 GPU 運作時，為避開 blocking 操作而使用 OpenCL

```c
cl_kernel clKrn;
...

#pragma omp parallel for firstprivate(clKrn) // what's firstprivate ?
for (int i = 0; i < Q; i++) {
    ...
    clStat = clSetKernelArg(clKrn, 0, sizeof(cl_uint), (void *) &N);
    ...//                   ^race condition
}
```

請建立多個 kernel object，如下

```c
cl_kernel clKrn[DEVICE_NUM];
...

#pragma omp parallel for
for (int i = 0; i < Q; i++) {
    ...
    clStat = clSetKernelArg(clKrn[DEVICE_ID], 0, sizeof(cl_uint), (void *) &N);
    ...//                   ^safe
}
```

---

## 錯誤案例 Error Argument Type ##

* 別忘了物件和位址的差別

* 請多下 `gcc -Wall` 幫助你檢查這些強制轉型

* 查好 API，小心行事


```c
clCreateCommandQueue(cl_context, cl_device_id, cl_command_queue_properties, cl_int*);
                              // ^object
clBuildProgram(cl_program, cl_uint num_devices, const cl_device_id *device_list,
                                // ^number                         ^begin address, not object
    const char*, void (*)(cl_program, void *user_data), void *)
```

```c
cl_device_id    clGPUID[MAXGPU];
...
clBuildProgram(clPrg[i], 1,   clGPUID+i, NULL, NULL, NULL);  // ok
clBuildProgram(clPrg[i], 1, &clGPUID[i], NULL, NULL, NULL);  // ok
clBuildProgram(clPrg[i], 1,  clGPUID[i], NULL, NULL, NULL);  // no, get far away from me.
```

---

### 錯誤案例 Parallel Kernel Execution ###

* 如果你要在 OpenCL 模擬出 CUDA 的 cudaStream，當心！

* 手動模擬存在許多無法預期的結果

```c
cl_kernel           clKrn;
cl_command_queue    clQue;

#pragma omp parallel for
for (int i = 0; i < Q; i++) {
    ...
    clEnqueueNDRangeKernel(clQue, clKrn, 1, globalOffset,
                globalSize, localSize, 0, NULL, NULL);
    clEnqueueReadBuffer(...);
    // I don't know what's the status happened
    // horrible !!!!!!
    ...
}
```



    </textarea>
	<script src="./javascripts/remark-latest.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
</script>
    <script type="text/javascript">
      var slideshow = remark.create();

      // Setup MathJax
      MathJax.Hub.Config({
          tex2jax: {
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
          }
      });
/*
      MathJax.Hub.Queue(function() {
          MathJax.Hub.getAllJax().map(function(index, elem) {
              return(elem.SourceElement());
          }).parent().addClass('has-jax');
      });
*/
      MathJax.Hub.Configured();
    </script>
  </body>
</html>
